---
title: Troubleshooting
---

# Troubleshooting

Common problems encountered when running HEDGEHOG, with explanations and solutions.

## Docking Script Path Issues

Docking scripts generated by HEDGEHOG execute from a `_workdir/` subdirectory inside the docking stage output, **not** from the stage directory itself. This causes path resolution issues if relative paths are used.

Three specific path bugs to watch for:

1. **Config reference** — the docking config file lives in the pipeline's root working directory. Use an absolute path or `config_file.relative_to(ligands_dir)` instead of just the file name.
2. **Ligprep `-osd` flag** — the output SDF path must be absolute, otherwise it resolves relative to `_workdir/`, creating nested `_workdir/_workdir/` paths.
3. **Ligprep `-icsv` flag** — same issue as above; the input CSV path must be absolute.

**Symptoms:** docking jobs fail with `FileNotFoundError`, or output files appear in unexpected nested directories.

**Fix:** ensure all paths passed to docking scripts are absolute:

```python
# Wrong: relative path breaks when cwd is _workdir/
script_args = ["-osd", str(output_sdf)]

# Correct: always resolve to absolute
script_args = ["-osd", str(output_sdf.resolve())]
```

## Conda / Mamba Detection (GNINA)

If you configure GNINA to run inside an existing conda environment, HEDGEHOG may need to locate
`conda.sh` to activate that environment before launching GNINA. When `conda_sh` is not provided in
your docking configuration, HEDGEHOG auto-detects common conda installs by searching for these
directory names under the user's home:

- `miniforge`
- `miniconda3`
- `mambaforge`
- `anaconda3`

**Symptom:** docking (GNINA) stage fails with an error like `conda not found` or `CondaError`, or
GNINA cannot find required shared libraries after activation.

**Fix:** ensure one of the supported conda distributions is installed and its `bin/` directory is on
your `PATH`, or set `conda_sh` explicitly to your `.../etc/profile.d/conda.sh` path.

```bash
# Verify conda is accessible
conda --version

# If using miniforge, conda.sh is typically here:
ls ~/miniforge/etc/profile.d/conda.sh
```

## Autobox Coordinate Frame Mismatch

When using autobox docking (where the search box is derived from a reference ligand SDF), the reference ligand **must be in the same coordinate frame** as the receptor PDB file.

**Symptom:** docking scores are unreasonably poor, or all poses are placed far from the binding site.

**Common cause:** the reference ligand was extracted from an apo (ligand-free) crystal structure, but the receptor PDB comes from a holo (ligand-bound) structure with a different coordinate frame. Even small translations or rotations between crystal structures cause the autobox to miss the binding pocket entirely.

**Fix:** superimpose the apo and holo structures before extracting the reference ligand, or use a reference ligand from the same PDB file as the receptor:

```python
from Bio.PDB import PDBParser, Superimposer

parser = PDBParser(QUIET=True)
ref_struct = parser.get_structure("holo", "receptor_holo.pdb")
mobile_struct = parser.get_structure("apo", "receptor_apo.pdb")

# Superimpose using CA atoms, then transform the reference ligand
sup = Superimposer()
sup.set_atoms(ref_atoms, mobile_atoms)
sup.apply(mobile_struct.get_atoms())
```

## Schrodinger Licensing

The optional ligand preparation and protein preparation steps use Schrodinger tools (`LigPrep` and `PrepWizard`). These require a valid Schrodinger license.

**Symptom:** pipeline fails at input preprocessing with errors mentioning `SCHRODINGER` or license checkout failures.

**Fix:**

1. Set the `SCHRODINGER` environment variable to your Schrodinger installation directory:

```bash
export SCHRODINGER=/opt/schrodinger/suites2024-1
```

2. Verify the license server is accessible:

```bash
$SCHRODINGER/licadmin STAT
```

3. If you do not have a Schrodinger license, remove or clear the `ligand_preparation_tool` and `protein_preparation_tool` fields in `config.yml`. HEDGEHOG will skip Schrodinger preprocessing and rely on the Mol Prep stage (Datamol standardization), which does not require a license:

```yaml
# config.yml — disable Schrodinger tools
ligand_preparation_tool:
protein_preparation_tool:
```

## Memory Issues with Large SDF Files

Docking stages load and process SDF files that can grow very large when docking thousands of molecules. This may cause out-of-memory errors, especially on systems with limited RAM.

**Symptoms:** the process is killed by the OS (`Killed` or `OOM`), or you see `MemoryError` in the log.

**Mitigations:**

1. **Reduce input size** — use the `sample_size` parameter in `config.yml` to cap the number of molecules entering the pipeline:

```yaml
sample_size: 500  # Process at most 500 molecules
```

2. **Split input files** — divide your input CSV into smaller batches and run the pipeline on each batch separately.

3. **Reduce parallelism** — lower `n_jobs` to reduce peak memory from concurrent docking processes:

```yaml
n_jobs: 8  # Default is often set to all cores
```

4. **Monitor memory** — watch system memory during the docking stage:

```bash
# In a separate terminal
watch -n 5 free -h
```

## AiZynthFinder Installation

The retrosynthesis stage requires AiZynthFinder, which is installed in a virtual environment managed by `uv` via the provided installer script.

**Symptom:** synthesis stage fails with `ModuleNotFoundError: aizynthfinder` or the retrosynthesis subprocess exits immediately.

**Fix:**

1. Run the installer from the project root:

```bash
./modules/install_aizynthfinder.sh
```

This script clones the retrosynthesis repository into `./modules/retrosynthesis/`, installs dependencies with `uv sync`, and downloads the required public data (model files and templates).

2. Verify the installation:

```bash
# Check that the virtual environment exists
ls ./modules/retrosynthesis/aizynthfinder/.venv/

# Check that public data was downloaded
ls ./modules/retrosynthesis/aizynthfinder/public/

# Check that model data files exist
ls ./modules/retrosynthesis/aizynthfinder/aizynthfinder/data/
```

3. If the installer fails during the clone step, ensure you have SSH access to the LigandPro GitHub organization, or switch to HTTPS in the script.

## TUI Port Conflicts

The TUI (Text User Interface) uses a JSON-RPC protocol over stdio to communicate between the Node.js frontend and the Python backend. The backend is launched as a child process — it does **not** bind to a network port by default.

However, the Node.js development server (used during TUI development) binds to a local port. If that port is already in use, the TUI will fail to start.

**Symptom:** `Error: listen EADDRINUSE` when launching the TUI in development mode.

**Fix:**

1. Find and kill the process using the port:

```bash
# Find what is using port 3000
lsof -i :3000

# Kill the process
kill <PID>
```

2. For production use, launch the TUI via the CLI command, which uses the built bundle and stdio communication without binding any port:

```bash
uv run hedgehog tui
```

3. If the TUI has not been built yet, the CLI will automatically run `npm install && npm run build` inside the `tui/` directory before launching.

## Environment-Specific Docking Config

The default docking configuration file (`config_docking.yml`) ships with absolute paths that reference a specific server mount (`/mnt/...`). These paths will not exist on other machines.

**Symptom:** docking stage fails immediately with `FileNotFoundError` for receptor PDB or reference ligand files.

**Fix:** edit `src/hedgehog/configs/config_docking.yml` and update all absolute paths to match your local environment:

```yaml
receptor_pdb: /path/to/your/receptor.pdb
ref_ligand: /path/to/your/reference_ligand.sdf
```

## Common Log Messages

| Log message | Meaning | Action |
|---|---|---|
| `No data available for structural filters` | The previous stage produced no output | Check that descriptors stage completed and produced molecules |
| `Synthesis finished but no output file detected` | AiZynthFinder did not write results | Check AiZynthFinder installation and that model/public data files exist |
| `Docking finished but no results detected in output directories` | Neither SMINA nor GNINA produced output | Check binary paths and receptor PDB |
| `No molecules left after synthesis` | All molecules were filtered out | Relax synthesis thresholds in `config_synthesis.yml` |
| `Pipeline completed with failures` | At least one enabled stage did not complete | Review the per-stage status in the log output |
